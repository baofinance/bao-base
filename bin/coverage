#!/usr/bin/env bash
set -e
set -o pipefail

[[ "${BAO_BASE_VERBOSITY}" -gt 0 ]] && set -x
# separate build output & cache
export FOUNDRY_OUT=out/_coverage
export FOUNDRY_CACHE_PATH=cache/_coverage

# signal to Solidity code that we're in coverage mode
export BAO_COVERAGE_RUN=true

# temp deployment scripts dir
mkdir -p tmp
export BAO_DEPLOYMENT_LOGS_ROOT=$(mktemp -d -p tmp)
trap 'rm -rf "${BAO_DEPLOYMENT_LOGS_ROOT}"' EXIT

# run the coverage
forge coverage --out ${FOUNDRY_OUT} --nmp 'script/**/*.t.sol' --report summary --report lcov "$@"
{ set +x; } 2>/dev/null

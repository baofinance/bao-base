#!/bin/bash
set -e -o pipefail

if [[ -n "${GUARD_SOURCING_RECORDING:-}" ]]; then return; fi; GUARD_SOURCING_RECORDING=1
[[ -n "${LOADING:-}" ]] && echo "loading ${BASH_SOURCE[0]}..."


json_logging_file=''

# setup the file to log to
recording_to() {
    local network="$1"
    local name="$2"
    mkdir -p ./deploy
    json_logging_file="./deploy/$network-$name-$(date '+%Y-%m-%d_%H:%M:%S').log" || exit $?
    echo '{}' > $json_logging_file
}


# Add a numeric field to the JSON file
recording_field_numeric() {
    local key="$1"
    local value="$2"
    _add_json_to_file "{\"$key\": $value}"
}

# Add a string/address field to the JSON file
recording_field() {
    local key="$1"
    local value="$2"
    _add_json_to_file "{\"$key\": \"$value\"}"
}

###################################################################
# private functions

_add_json_to_file() {
    if [[ -z "$json_logging_file" ]]; then
        echo "Error: call to_log(filename) before logging"
    else
        local temp
        temp=$(mktemp) || exit $?
        jq ". + $1" "$json_logging_file" > "$temp" && mv "$temp" "$json_logging_file"
    fi
}

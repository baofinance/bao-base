#!/usr/bin/env bash
#
# Deploy BaoFactory via Nick's Factory (CREATE2)
#
# Usage:
#   deploy-factory --production --network mainnet --account deployer   # Deploy production BaoFactory
#   deploy-factory --owner 0x... --salt Bao.Test.v1 --network local    # Deploy custom variant (local)
#
# The script:
# 1. For --production: uses committed BaoFactoryBytecode.sol
# 2. For --owner/--salt: generates bytecode on-the-fly in temp dir
# 3. Deploys implementation via Nick's Factory (CREATE2)
# 4. The constructor deploys the ERC1967 proxy
# 5. Appends to deployments/BaoFactory.json
# 6. Verifies contracts on Etherscan (if --verify and non-local network)
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
DEPLOYMENTS_FILE="$PROJECT_ROOT/deployments/BaoFactory.json"

# Nick's Factory address (same on all EVM chains)
NICKS_FACTORY="0x4e59b44847b379578588920cA78FbF26c0B4956C"

# Production defaults
PRODUCTION_OWNER="0x9bABfC1A1952a6ed2caC1922BFfE80c0506364a2"
PRODUCTION_SALT="Bao.BaoFactory.harbor"

# Deterministic compiler settings (must match extract-bytecode)
SOLC_VERSION="0.8.30"
EVM_VERSION="prague"

# Default anvil private key (account 0)
ANVIL_PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

usage() {
  cat <<EOF
Usage: deploy-factory --network NETWORK [OPTIONS]

Deploy BaoFactory via Nick's Factory (CREATE2)

Required:
  --network <name>      Network name (must exist in foundry.toml rpc_endpoints)

Options:
  --production          Deploy production BaoFactory (uses committed bytecode)
  --owner <address>     Owner address (requires --salt, generates on-the-fly)
  --salt <string>       Salt string (requires --owner, or overrides default with --production)
  --account <name>      Foundry keystore account name (from ~/.foundry/keystores/)
  --no-verify           Skip contract verification (verification is default for non-local)
  --dry-run             Show what would be deployed without executing
  -h, --help            Show this help message

Wallet:
  For 'local' network: uses first Anvil account (0xac0974...) unless --account specified
  For other networks:  --account is required

Examples:
  # Deploy production to mainnet using keystore
  deploy-factory --network mainnet --production --account deployer --verify

  # Deploy custom variant for local testing (uses default anvil key)
  deploy-factory --network local --owner 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --salt Bao.BaoFactoryAnvil.v1

EOF
  exit "${1:-0}"
}

error() {
  echo "ERROR: $*" >&2
  exit 1
}

log() {
  echo "==> $*"
}

# Compute CREATE2 address: keccak256(0xff ++ factory ++ salt ++ keccak256(initCode))[12:]
predict_create2_address() {
  local factory="$1"
  local salt_bytes="$2" # Already hex-encoded 32-byte salt (no 0x prefix)
  local init_code="$3"  # Hex-encoded bytecode (with 0x prefix)

  local init_code_hash
  init_code_hash=$(cast keccak "$init_code")

  # Compute CREATE2 address
  local packed
  packed="0xff${factory#0x}${salt_bytes}${init_code_hash#0x}"
  local hash
  hash=$(cast keccak "$packed")

  # Take last 20 bytes (address)
  echo "0x${hash:26}"
}

# Compute CREATE address for nonce=1: keccak256(rlp([sender, 1]))[12:]
predict_create_address_nonce1() {
  local sender="$1"

  # RLP encoding for [address, 1]: 0xd6 0x94 <20-byte-address> 0x01
  local packed="0xd694${sender#0x}01"
  local hash
  hash=$(cast keccak "$packed")

  # Take last 20 bytes
  echo "0x${hash:26}"
}

# Get production bytecode from committed BaoFactoryBytecode.sol
get_production_bytecode() {
  local bytecode_file="$SCRIPT_DIR/BaoFactoryBytecode.sol"

  if [[ ! -f "$bytecode_file" ]]; then
    error "BaoFactoryBytecode.sol not found. Run ./src/factory/extract-bytecode first."
  fi

  # Extract bytecode from the file
  local bytecode
  bytecode=$(grep -A1 "bytes internal constant CREATION_CODE =" "$bytecode_file" |
    grep -oP 'hex"[^"]*"' | sed 's/hex"//g' | sed 's/"//g' | tr -d '\n')

  if [[ -z "$bytecode" ]]; then
    error "Could not extract bytecode from BaoFactoryBytecode.sol"
  fi

  echo "0x$bytecode"
}

# Generate bytecode on-the-fly for custom owner
generate_custom_bytecode() {
  local owner="$1"
  local temp_dir="$2"

  log "Generating bytecode for owner $owner..."
  echo "    Temp dir: $temp_dir"

  # Create foundry.toml with deterministic settings
  # Hardcoded remappings for reproducibility
  cat >"$temp_dir/foundry.toml" <<EOF
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc_version = "$SOLC_VERSION"
evm_version = "$EVM_VERSION"
bytecode_hash = "none"
cbor_metadata = false
optimizer = true
optimizer_runs = 10000
via_ir = true
remappings = [
  "@solady/=lib/solady/src/",
  "@bao/=src/"
]
EOF

  # Create directory structure
  mkdir -p "$temp_dir/src/factory"
  mkdir -p "$temp_dir/src/interfaces"
  mkdir -p "$temp_dir/lib"

  # Copy source files
  cp "$SCRIPT_DIR/BaoFactory.sol" "$temp_dir/src/factory/"
  cp "$SCRIPT_DIR/BaoFactoryLib.sol" "$temp_dir/src/factory/"
  cp "$PROJECT_ROOT/src/interfaces/IBaoFactory.sol" "$temp_dir/src/interfaces/"

  # Substitute owner address
  sed -i "s/$PRODUCTION_OWNER/$owner/g" "$temp_dir/src/factory/BaoFactory.sol"

  # Symlink libraries
  ln -s "$PROJECT_ROOT/lib/solady" "$temp_dir/lib/solady"

  # Compile
  log "Compiling with deterministic settings..."
  cd "$temp_dir"
  forge build --force 2>&1 | sed 's/^/    /'

  # Extract bytecode
  local artifact="$temp_dir/out/BaoFactory.sol/BaoFactory.json"
  if [[ ! -f "$artifact" ]]; then
    error "Compilation failed - artifact not found"
  fi

  local bytecode
  bytecode=$(jq -r '.bytecode.object' "$artifact")
  if [[ -z "$bytecode" || "$bytecode" == "null" ]]; then
    error "Failed to extract bytecode from artifact"
  fi

  cd "$PROJECT_ROOT"
  echo "$bytecode"
}

# Append deployment to registry
append_to_registry() {
  local owner="$1"
  local factory="$2"

  # Create deployments directory if needed
  mkdir -p "$(dirname "$DEPLOYMENTS_FILE")"

  # Initialize file if it doesn't exist
  if [[ ! -f "$DEPLOYMENTS_FILE" ]]; then
    echo "[]" >"$DEPLOYMENTS_FILE"
  fi

  # Check if entry already exists
  local existing
  existing=$(jq -r --arg owner "$owner" '.[] | select(.owner == $owner) | .factory' "$DEPLOYMENTS_FILE")

  if [[ -n "$existing" ]]; then
    log "Updating existing registry entry for owner $owner"
    # Update existing entry
    local tmp
    tmp=$(mktemp)
    jq --arg owner "$owner" --arg factory "$factory" \
      '(.[] | select(.owner == $owner)) .factory = $factory' \
      "$DEPLOYMENTS_FILE" >"$tmp" && mv "$tmp" "$DEPLOYMENTS_FILE"
  else
    log "Adding new registry entry"
    # Append new entry
    local tmp
    tmp=$(mktemp)
    jq --arg owner "$owner" --arg factory "$factory" \
      '. += [{"owner": $owner, "factory": $factory}]' \
      "$DEPLOYMENTS_FILE" >"$tmp" && mv "$tmp" "$DEPLOYMENTS_FILE"
  fi
}

# ============================================================================
# MAIN SCRIPT
# ============================================================================

# Parse arguments
NETWORK=""
SALT=""
OWNER=""
ACCOUNT=""
PRODUCTION=false
NO_VERIFY=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --network)
      NETWORK="$2"
      shift 2
      ;;
    --production)
      PRODUCTION=true
      shift
      ;;
    --salt)
      SALT="$2"
      shift 2
      ;;
    --owner)
      OWNER="$2"
      shift 2
      ;;
    --account)
      ACCOUNT="$2"
      shift 2
      ;;
    --no-verify)
      NO_VERIFY=true
      shift
      ;;
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    -h | --help)
      usage 0
      ;;
    *)
      error "Unknown option: $1"
      ;;
  esac
done

# Validate network
if [[ -z "$NETWORK" ]]; then
  error "--network is required"
fi

# Set up wallet arguments based on network and --account
WALLET_ARGS=""
VERIFY=false
if [[ "$NETWORK" == "local" ]]; then
  # Verification not possible for local network
  if [[ "$NO_VERIFY" == "false" ]]; then
    log "Note: verification not available for local network"
  fi

  if [[ -n "$ACCOUNT" ]]; then
    # Use specified keystore account
    WALLET_ARGS="--account $ACCOUNT"
  else
    # Default to first Anvil account for local testing
    WALLET_ARGS="--private-key $ANVIL_PRIVATE_KEY"
  fi
else
  # Non-local networks: verify by default unless --no-verify
  if [[ "$NO_VERIFY" == "false" ]]; then
    VERIFY=true
  fi

  # Non-local networks require --account
  if [[ -z "$ACCOUNT" ]]; then
    error "--account is required for non-local networks"
  fi
  WALLET_ARGS="--account $ACCOUNT"
fi

# Set up etherscan key for verification (from environment)
if [[ "$VERIFY" == "true" ]]; then
  if [[ -z "${ETHERSCAN_KEY:-}" ]]; then
    error "ETHERSCAN_KEY environment variable required for --verify"
  fi
fi

# Validate arguments
if [[ "$PRODUCTION" == "true" ]]; then
  if [[ -n "$OWNER" ]]; then
    error "--production cannot be combined with --owner"
  fi
  # --salt overrides PRODUCTION_SALT if specified
  SALT="${SALT:-$PRODUCTION_SALT}"
  OWNER="$PRODUCTION_OWNER"
elif [[ -n "$SALT" || -n "$OWNER" ]]; then
  if [[ -z "$SALT" ]]; then
    error "--owner requires --salt"
  fi
  if [[ -z "$OWNER" ]]; then
    error "--salt requires --owner"
  fi
  # Validate owner is a valid address
  if ! [[ "$OWNER" =~ ^0x[0-9a-fA-F]{40}$ ]]; then
    error "Invalid owner address: $OWNER"
  fi
else
  error "Must specify either --production or both --owner and --salt"
fi

# Get bytecode
TEMP_DIR=""
if [[ "$PRODUCTION" == "true" ]]; then
  log "Using committed production bytecode..."
  BYTECODE=$(get_production_bytecode)
else
  # Create temp directory for on-the-fly compilation
  TEMP_DIR=$(mktemp -d)
  # Don't clean up automatically - user may want to inspect
  BYTECODE=$(generate_custom_bytecode "$OWNER" "$TEMP_DIR")
fi

BYTECODE_HASH=$(cast keccak "$BYTECODE")

log "BaoFactory Deployment"
log "===================="
echo "  Mode:     $([ "$PRODUCTION" == "true" ] && echo "Production (committed bytecode)" || echo "Custom (on-the-fly)")"
echo "  Salt:     $SALT"
echo "  Owner:    $OWNER"
echo "  Network:  $NETWORK"
echo "  Verify:   $VERIFY"
if [[ -n "$TEMP_DIR" ]]; then
  echo "  Temp dir: $TEMP_DIR"
fi
echo ""
echo "  Bytecode hash: $BYTECODE_HASH"
echo "  Bytecode size: $(((${#BYTECODE} - 2) / 2)) bytes"

# Compute salt as bytes32 (keccak256 of salt string)
SALT_BYTES=$(cast keccak "$(cast --from-utf8 "$SALT")" | sed 's/0x//')
echo "  Salt bytes32:  0x$SALT_BYTES"

# Predict addresses
log "Predicting addresses..."
IMPL_ADDRESS=$(predict_create2_address "$NICKS_FACTORY" "$SALT_BYTES" "$BYTECODE")
PROXY_ADDRESS=$(predict_create_address_nonce1 "$IMPL_ADDRESS")
echo "  Implementation: $IMPL_ADDRESS"
echo "  Proxy:          $PROXY_ADDRESS"
echo ""

# Check if already deployed
IMPL_CODE=$(cast code "$IMPL_ADDRESS" --rpc-url "$NETWORK" 2>/dev/null || echo "0x")
if [[ "$IMPL_CODE" != "0x" && "$IMPL_CODE" != "" ]]; then
  log "Implementation already deployed at $IMPL_ADDRESS"
  PROXY_CODE=$(cast code "$PROXY_ADDRESS" --rpc-url "$NETWORK" 2>/dev/null || echo "0x")
  if [[ "$PROXY_CODE" != "0x" && "$PROXY_CODE" != "" ]]; then
    log "Proxy already deployed at $PROXY_ADDRESS"
  fi

  # Verify owner
  DEPLOYED_OWNER=$(cast call "$PROXY_ADDRESS" "owner()(address)" --rpc-url "$NETWORK" 2>/dev/null || echo "")
  if [[ -n "$DEPLOYED_OWNER" ]]; then
    echo "  Deployed owner: $DEPLOYED_OWNER"
    if [[ "${DEPLOYED_OWNER,,}" != "${OWNER,,}" ]]; then
      error "Deployed owner ($DEPLOYED_OWNER) does not match expected ($OWNER)"
    fi
  fi

  if [[ "$VERIFY" == "true" ]]; then
    log "Skipping deployment, proceeding to verification..."
  else
    log "Nothing to deploy. Use --verify to verify existing deployment."
    exit 0
  fi
else
  if [[ "$DRY_RUN" == "true" ]]; then
    log "DRY RUN - would deploy to:"
    echo "  Implementation: $IMPL_ADDRESS"
    echo "  Proxy:          $PROXY_ADDRESS"
    exit 0
  fi

  # Deploy via Nick's Factory
  log "Deploying via Nick's Factory..."

  # Nick's Factory expects: salt (32 bytes) + creation code
  DEPLOY_DATA="0x${SALT_BYTES}${BYTECODE#0x}"

  TX_HASH=$(cast send --json --rpc-url "$NETWORK" $WALLET_ARGS \
    "$NICKS_FACTORY" "$DEPLOY_DATA" | jq -r '.transactionHash')

  if [[ -z "$TX_HASH" || "$TX_HASH" == "null" ]]; then
    error "Deployment transaction failed"
  fi

  log "Transaction submitted: $TX_HASH"

  # Wait for confirmation
  log "Waiting for confirmation..."
  cast receipt --rpc-url "$NETWORK" "$TX_HASH" >/dev/null

  # Verify deployment
  IMPL_CODE=$(cast code "$IMPL_ADDRESS" --rpc-url "$NETWORK")
  if [[ "$IMPL_CODE" == "0x" || "$IMPL_CODE" == "" ]]; then
    error "Implementation deployment failed - no code at $IMPL_ADDRESS"
  fi

  PROXY_CODE=$(cast code "$PROXY_ADDRESS" --rpc-url "$NETWORK")
  if [[ "$PROXY_CODE" == "0x" || "$PROXY_CODE" == "" ]]; then
    error "Proxy deployment failed - no code at $PROXY_ADDRESS"
  fi

  log "Deployment successful!"
  echo "  Implementation: $IMPL_ADDRESS"
  echo "  Proxy:          $PROXY_ADDRESS"
  echo "  Transaction:    $TX_HASH"

  # Update registry
  append_to_registry "$OWNER" "$PROXY_ADDRESS"
  log "Updated $DEPLOYMENTS_FILE"
fi

# Verification
if [[ "$VERIFY" == "true" ]]; then
  log "Verifying contracts on Etherscan..."

  # Get chain ID for verification
  CHAIN_ID=$(cast chain-id --rpc-url "$NETWORK")

  if [[ "$PRODUCTION" == "true" ]]; then
    # Production: verify against original source
    log "Verifying implementation at $IMPL_ADDRESS..."
    forge verify-contract \
      --chain-id "$CHAIN_ID" \
      --etherscan-api-key "$ETHERSCAN_KEY" \
      --watch \
      --compiler-version "$SOLC_VERSION" \
      --optimizer-runs 10000 \
      --via-ir \
      "$IMPL_ADDRESS" \
      "src/factory/BaoFactory.sol:BaoFactory" ||
      echo "Warning: Implementation verification failed (may already be verified)"
  else
    # Custom variant: verify against temp directory source (has substituted owner)
    if [[ -z "$TEMP_DIR" || ! -d "$TEMP_DIR" ]]; then
      log "Warning: Cannot verify custom variant - temp directory not available"
      log "         Re-run without --verify, then verify manually with the temp source"
    else
      log "Verifying implementation at $IMPL_ADDRESS (custom variant)..."
      forge verify-contract \
        --chain-id "$CHAIN_ID" \
        --etherscan-api-key "$ETHERSCAN_KEY" \
        --watch \
        --root "$TEMP_DIR" \
        --compiler-version "$SOLC_VERSION" \
        --optimizer-runs 10000 \
        --via-ir \
        "$IMPL_ADDRESS" \
        "src/factory/BaoFactory.sol:BaoFactory" ||
        echo "Warning: Implementation verification failed"
    fi
  fi

  # Note: The proxy is a minimal ERC1967 proxy deployed by LibClone
  # It cannot be verified in the traditional sense as it has no source
  log "Note: Proxy at $PROXY_ADDRESS is a minimal ERC1967 proxy (61 bytes)"
  log "      It uses the implementation at $IMPL_ADDRESS"
fi

log "Done!"
echo ""
echo "BaoFactory deployed:"
echo "  Proxy (use this):     $PROXY_ADDRESS"
echo "  Implementation:       $IMPL_ADDRESS"
echo "  Owner:                $OWNER"
if [[ -n "$TEMP_DIR" ]]; then
  echo ""
  echo "Temp directory preserved for inspection: $TEMP_DIR"
  echo "Remove with: rm -rf $TEMP_DIR"
fi

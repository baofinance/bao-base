#!/usr/bin/env bash
#
# Extract production BaoFactory bytecode for deterministic deployment
#
# Compiles BaoFactory.sol with deterministic compiler settings and
# generates BaoFactoryBytecode.sol containing the creation code.
#
# Output should be committed to the repo.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
OUTPUT_FILE="$SCRIPT_DIR/BaoFactoryBytecode.sol"

# Production owner (must match BaoFactory.sol)
PRODUCTION_OWNER="0x9bABfC1A1952a6ed2caC1922BFfE80c0506364a2"

# Deterministic compiler settings
SOLC_VERSION="0.8.30"
EVM_VERSION="prague"

cd "$PROJECT_ROOT"

echo "=== BaoFactory Bytecode Extraction ==="
echo "  Source:  src/factory/BaoFactory.sol"
echo "  Output:  $OUTPUT_FILE"
echo "  Solc:    $SOLC_VERSION"
echo "  EVM:     $EVM_VERSION"
echo ""

# Create temp directory for deterministic compilation
TEMP_DIR=$(mktemp -d)
# Note: temp dir is preserved for inspection, not auto-cleaned
# trap "rm -rf $TEMP_DIR" EXIT

echo "==> Creating temp compilation environment..."
echo "    $TEMP_DIR"

# Create foundry.toml with deterministic settings
# Hardcoded remappings for reproducibility
cat >"$TEMP_DIR/foundry.toml" <<EOF
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc_version = "$SOLC_VERSION"
evm_version = "$EVM_VERSION"
bytecode_hash = "none"
cbor_metadata = false
optimizer = true
optimizer_runs = 10000
via_ir = true
remappings = [
  "@solady/=lib/solady/src/",
  "@bao-factory/=src/factory/"
]
EOF

# Create directory structure
mkdir -p "$TEMP_DIR/src/factory"
mkdir -p "$TEMP_DIR/src/interfaces"
mkdir -p "$TEMP_DIR/lib"

# Copy source files
cp "$SCRIPT_DIR/BaoFactory.sol" "$TEMP_DIR/src/factory/"
cp "$SCRIPT_DIR/BaoFactoryLib.sol" "$TEMP_DIR/src/factory/"
cp "$SCRIPT_DIR/IBaoFactory.sol" "$TEMP_DIR/src/factory/"

# Symlink libraries
ln -s "$PROJECT_ROOT/lib/solady" "$TEMP_DIR/lib/solady"

echo "==> Compiling with deterministic settings..."
cd "$TEMP_DIR"
forge build --force 2>&1 | sed 's/^/    /'

# Extract bytecode
ARTIFACT="$TEMP_DIR/out/BaoFactory.sol/BaoFactory.json"
if [[ ! -f "$ARTIFACT" ]]; then
  echo "ERROR: Compilation failed - artifact not found"
  exit 1
fi

BYTECODE=$(jq -r '.bytecode.object' "$ARTIFACT")
if [[ -z "$BYTECODE" || "$BYTECODE" == "null" ]]; then
  echo "ERROR: Failed to extract bytecode"
  exit 1
fi

# Remove 0x prefix for hex literal
BYTECODE_HEX="${BYTECODE#0x}"

# Compute hash
BYTECODE_HASH=$(cast keccak "$BYTECODE")

echo ""
echo "==> Extracted bytecode:"
echo "    Size: $((${#BYTECODE_HEX} / 2)) bytes"
echo "    Hash: $BYTECODE_HASH"

# Get metadata
TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
GIT_COMMIT=$(cd "$PROJECT_ROOT" && git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Generate output file
cd "$PROJECT_ROOT"

cat >"$OUTPUT_FILE" <<EOF
// SPDX-License-Identifier: MIT
pragma solidity >=0.8.28 <0.9.0;

// ============================================================================
// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// ============================================================================
// Generated: $TIMESTAMP
// Git commit: $GIT_COMMIT
// Compiler: solc $SOLC_VERSION
// EVM version: $EVM_VERSION
// Optimizer: true (runs: 10000, via_ir: true)
// Metadata: none (bytecode_hash = "none", cbor_metadata = false)
// ============================================================================
//
// This file contains the captured creation code for BaoFactory.
// To regenerate: ./src/factory/extract-bytecode
//
// Owner: $PRODUCTION_OWNER (Harbor multisig)
// ============================================================================

/// @title BaoFactoryBytecode
/// @notice Contains captured creation code for deterministic BaoFactory deployment
/// @dev Generated bytecode ensures consistent addresses regardless of compiler changes
library BaoFactoryBytecode {
    /// @dev BaoFactory creation code
    bytes internal constant CREATION_CODE =
        hex"$BYTECODE_HEX";

    /// @dev keccak256 of CREATION_CODE
    bytes32 internal constant CREATION_CODE_HASH =
        $BYTECODE_HASH;
}
EOF

echo ""
echo "==> Generated $OUTPUT_FILE"
echo ""
echo "Temp directory: $TEMP_DIR"
echo "Done! Remember to commit the updated BaoFactoryBytecode.sol"

// SPDX-License-Identifier: MIT
pragma solidity >=0.8.28 <0.9.0;

import {Test} from "forge-std/Test.sol";
import {DeploymentDataJsonTesting} from "@bao-script/deployment/DeploymentDataJsonTesting.sol";

contract DeploymentConfigSetup is Test {
    DeploymentDataJsonTesting internal config;

    function setUp() public virtual {
        config = new DeploymentDataJsonTesting(_loadFixture());
    }

    function _loadFixture() internal view returns (string memory text) {
        string memory root = vm.projectRoot();
        string memory primary = string.concat(root, "/test/fixtures/deployment/config-basic.json");
        try vm.readFile(primary) returns (string memory contents) {
            return contents;
        } catch {
            string memory fallbackPath = string.concat(
                root,
                "/lib/bao-base/test/fixtures/deployment/config-basic.json"
            );
            return vm.readFile(fallbackPath);
        }
    }
}

contract DeploymentConfigTest is DeploymentConfigSetup {
    function test_getAddress_prefersContractOverride_() public view {
        address owner = DeploymentConfig.get(config, "pegged", "owner");
        address expected = vm.parseAddress("0x0000000000000000000000000000000000bbbb01");
        assertEq(owner, expected, "pegged owner override value");
    }

    function test_getAddress_fallsBackToDefaultOwner_() public view {
        address owner = DeploymentConfig.get(config, "stabilityPoolCollateral", "owner");
        address expected = vm.parseAddress("0x0000000000000000000000000000000000aaaa01");
        assertEq(owner, expected, "collateral owner fallback");
    }

    function test_getString_prefersContractOverride_() public view {
        string memory symbol = DeploymentConfig.getString(config, "pegged", "symbol");
        assertEq(symbol, "cUSD", "pegged symbol override");
    }

    function test_getString_readsContractField_() public view {
        string memory name = DeploymentConfig.getString(config, "pegged", "name");
        assertEq(name, "Bao USD", "pegged name value");
    }

    function test_getUint_prefersContractOverride_() public view {
        uint256 minDeposit = DeploymentConfig.getUint(config, "stabilityPoolCollateral", "minDeposit");
        assertEq(minDeposit, 2 ether, "collateral minDeposit override");
    }

    function test_getUint_readsDirectContractField_() public view {
        uint256 feeBps = DeploymentConfig.getUint(config, "minter", "feeBps");
        assertEq(feeBps, 25, "minter feeBps value");
    }

    function test_getUint_missingContractValueReverts_() public {
        vm.expectRevert(
            abi.encodeWithSelector(DeploymentConfig.ConfigValueMissing.selector, "stabilityPoolLeveraged", "minDeposit")
        );
        this._getUint("stabilityPoolLeveraged", "minDeposit");
    }

    function test_missingFieldReverts_() public {
        vm.expectRevert(abi.encodeWithSelector(DeploymentConfig.ConfigValueMissing.selector, "unknown", "owner"));
        this._getOwner("unknown");
    }

    function test_conflictResolution_preferConfig_() public view {
        DeploymentConfig.ConflictResolution resolution = DeploymentConfig.conflictResolution(config, "owner");
        assertEq(
            uint256(resolution),
            uint256(DeploymentConfig.ConflictResolution.PreferConfig),
            "root conflict prefer config"
        );
    }

    function test_conflictResolution_preferLog_() public view {
        DeploymentConfig.ConflictResolution resolution = DeploymentConfig.conflictResolution(config, "minter.owner");
        assertEq(
            uint256(resolution),
            uint256(DeploymentConfig.ConflictResolution.PreferLog),
            "minter conflict prefer log"
        );
    }

    function test_conflictResolution_unspecified_() public view {
        DeploymentConfig.ConflictResolution resolution = DeploymentConfig.conflictResolution(config, "pegged.owner");
        assertEq(
            uint256(resolution),
            uint256(DeploymentConfig.ConflictResolution.Unspecified),
            "pegged conflict unspecified"
        );
    }

    function _getOwner(string memory contractKey) external view returns (address) {
        return DeploymentConfig.get(config, contractKey, "owner");
    }

    function _getUint(string memory contractKey, string memory fieldPath) external view returns (uint256) {
        return DeploymentConfig.getUint(config, contractKey, fieldPath);
    }
}

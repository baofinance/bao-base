name: Test Foundry
description: "runs all the tests for a Foundry solidity project"

# secrets:
#   DEFAULT_MAINNET_RPC_URL:
#     description: "default API URL for accessing blockchain service"
#     required: false
inputs:
  # os:
  #   description: "Operating system to test"
  #   required: true
  #   type: string
  foundry:
    description: "Foundry version to test"
    required: true

runs:
  using: "composite"
  steps:
    - name: Check Environment
      shell: bash
      run: |
        echo "runner.os=${{ runner.os }}"
        python3 -c "import platform; info = f'{platform.system()} {platform.release()} {platform.version()} {platform.machine()}'; print('-' * len(info)); print(info); print('-' * len(info))"
        bash --version

    - name: Install Bash 5.2 (on macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        brew install bash
        bash --version

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: ${{ inputs.FOUNDRY }}
    - shell: bash
      run: |
        forge --version

    - name: Install project dependencies
      shell: bash
      run: |
        yarn

    - name: Run Prettier
      shell: bash
      run: |
        yarn prettier --check
      id: prettier

    - name: Run Solhint
      shell: bash
      run: |
        yarn lint
      id: lint

    - name: Run Slither
      shell: bash
      run: |
        yarn slither
      id: slither

    - name: Run Forge build
      shell: bash
      run: |
        yarn sizes
      id: sizes

    - name: Run Forge tests
      shell: bash
      run: |
        echo MAINNET_RPC_URL: $MAINNET_RPC_URL
        echo DEFAULT_MAINNET_RPC_URL: $DEFAULT_MAINNET_RPC_URL
        yarn test
      id: test

    - name: Run Forge tests - coverage
      shell: bash
      run: |
        yarn coverage
      id: coverage

    - name: Run Forge tests - gas
      shell: bash
      run: |
        yarn gas
      id: gas

    - name: Check for changed repo files
      shell: bash
      run: |
        git status --short
        git diff --minimal --exit-code
      id: git-diffs
